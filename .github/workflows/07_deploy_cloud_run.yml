name: Deploy Cloud Run

on:
  workflow_call:
    inputs:
      gcp_project_id:
        required: true
        type: string
      gcp_region:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Cloud SDK
        run: |
          curl https://sdk.cloud.google.com | bash
          source $HOME/google-cloud-sdk/path.bash.inc

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "${GCP_SA_KEY}" > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project ${{ inputs.gcp_project_id }}
          gcloud config set run/region ${{ inputs.gcp_region }}

      - name: Deploy Cloud Run Service
        run: |
          gcloud run services replace cloud-run-service.yaml
          gcloud run services add-iam-policy-binding $(cat cloud-run-service.yaml | grep 'name:' | head -1 | cut -d: -f2 | tr -d ' ') \
            --member="allUsers" --role="roles/run.invoker" || echo "Policy binding already exists"
