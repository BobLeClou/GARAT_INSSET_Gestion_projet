name: CI/CD - Build, Push, Deploy

on:
	push:
		tags: ['*']
		branches: [ main ]

jobs:
	build_and_deploy:
		runs-on: ubuntu-latest
		defaults:
			run:
				shell: bash
		steps:
			- name: Checkout repository (fetch tags)
				uses: actions/checkout@v4
				with:
					fetch-depth: 0

			- name: Extract version from Git tag
				id: extract_version
				run: |
					if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
						VERSION="${GITHUB_REF#refs/tags/}"
					else
						VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
					fi
					echo "VERSION=$VERSION" >> $GITHUB_ENV
					echo "Version extracted: $VERSION"

			- name: Prepare image names
				run: |
					echo "IMAGE_BASE=${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}" >> $GITHUB_ENV
					echo "IMAGE_API=${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}:$VERSION" >> $GITHUB_ENV
					echo "IMAGE_API_LATEST=${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}:latest" >> $GITHUB_ENV

			- name: Login to Docker Hub
				uses: docker/login-action@v2
				with:
					username: ${{ secrets.DOCKER_HUB_USERNAME }}
					password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

			- name: Build and push API image
				env:
					IMAGE_API: ${{ env.IMAGE_API }}
					IMAGE_API_LATEST: ${{ env.IMAGE_API_LATEST }}
					VERSION: ${{ env.VERSION }}
				run: |
					docker build -t "$IMAGE_API" .
					docker tag "$IMAGE_API" "$IMAGE_API_LATEST"
					docker push "$IMAGE_API"
					docker push "$IMAGE_API_LATEST"

			- name: Build and push Fluent Bit image (uses repo's `fluent-bit.conf`)
				env:
					IMAGE_FLB: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}-fluentbit:${{ env.VERSION }}
				run: |
					if [ -f fluent-bit.conf ]; then
						cat > Dockerfile.flb <<'EOF'
						FROM fluent/fluent-bit:2.1
						COPY fluent-bit.conf /fluent-bit/etc/
						EOF
						docker build -f Dockerfile.flb -t "$IMAGE_FLB" .
						docker push "$IMAGE_FLB"
					else
						echo "No fluent-bit.conf found â€” skipping Fluent Bit image build"
					fi

			- name: Setup Google Cloud SDK
				uses: google-github-actions/setup-gcloud@v1
				with:
					service_account_key: ${{ secrets.GCP_SA_KEY }}
					project_id: ${{ secrets.GCP_PROJECT_ID }}

			- name: Build and push migrations image
				env:
					MIG_IMG: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}-migrations:${{ env.VERSION }}
				run: |
					DOCKERFILE=Dockerfile.migrations
					if [ ! -f "$DOCKERFILE" ]; then
						if [ -f Dockerfile ]; then
							DOCKERFILE=Dockerfile
						else
							echo "No Dockerfile found for migrations, skipping" && exit 0
						fi
					fi
					docker build -f "$DOCKERFILE" -t "$MIG_IMG" .
					docker push "$MIG_IMG"

			- name: Run DB migrations (optional)
				if: ${{ secrets.MIGRATION_COMMAND != '' }}
				env:
					MIG_IMG: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}-migrations:${{ env.VERSION }}
				run: |
					echo "Running migrations using cloud_sql_proxy and image: $MIG_IMG"
					echo "Writing service account key"
					echo "${{ secrets.GCP_SA_KEY }}" > gcloud-key.json
					curl -Lo cloud_sql_proxy https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64
					chmod +x cloud_sql_proxy
					./cloud_sql_proxy -instances="${{ secrets.CLOUD_SQL_CONNECTION_NAME }}"=tcp:3306 -credential_file=gcloud-key.json &
					sleep 3
					docker run --rm --network host \
						-e DB_HOST=127.0.0.1 -e DB_PORT=3306 \
						-e DB_NAME="${{ secrets.DB_NAME }}" -e DB_USER="${{ secrets.DB_USER }}" -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
						$MIG_IMG sh -c "${{ secrets.MIGRATION_COMMAND }}"

			- name: Render Cloud Run service YAML from template
				run: |
					if [ ! -f cloud-run-service.yaml.template ]; then
						echo "cloud-run-service.yaml.template missing" && exit 0
					fi
					cp cloud-run-service.yaml.template cloud-run-service.yaml
					sed -i "s|{{VERSION}}|${VERSION}|g" cloud-run-service.yaml || true
					sed -i "s|{{DOCKER_USERNAME}}|${{ secrets.DOCKER_HUB_USERNAME }}|g" cloud-run-service.yaml || true
					sed -i "s|{{GCP_PROJECT_ID}}|${{ secrets.GCP_PROJECT_ID }}|g" cloud-run-service.yaml || true
					sed -i "s|{{GCP_REGION}}|${{ secrets.GCP_REGION }}|g" cloud-run-service.yaml || true
					sed -i "s|{{DB_USER}}|${{ secrets.DB_USER }}|g" cloud-run-service.yaml || true
					sed -i "s|{{DB_PASSWORD}}|${{ secrets.DB_PASSWORD }}|g" cloud-run-service.yaml || true
					sed -i "s|{{DB_NAME}}|${{ secrets.DB_NAME }}|g" cloud-run-service.yaml || true
					sed -i "s|{{CLOUD_SQL_CONNECTION_NAME}}|${{ secrets.CLOUD_SQL_CONNECTION_NAME }}|g" cloud-run-service.yaml || true
					sed -i "s|{{LOKI_URL}}|${{ secrets.LOKI_URL }}|g" cloud-run-service.yaml || true

			- name: Deploy to Cloud Run
				env:
					PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
					REGION: ${{ secrets.GCP_REGION }}
					IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ github.event.repository.name }}:${{ env.VERSION }}
				run: |
					SERVICE_NAME=$(grep -E '^\s*name:\s*' cloud-run-service.yaml | head -n1 | awk '{print $2}' || true)
					if [ -n "$SERVICE_NAME" ]; then
						echo "Deploying using service definition: $SERVICE_NAME"
						gcloud run services replace cloud-run-service.yaml --project="$PROJECT_ID" --region="$REGION" || true
					else
						SERVICE_NAME=${{ github.event.repository.name }}
						echo "No service name in template, deploying $SERVICE_NAME with image $IMAGE"
						gcloud run deploy "$SERVICE_NAME" --image="$IMAGE" --region="$REGION" --project="$PROJECT_ID" --platform managed --allow-unauthenticated
					fi
					# Make service public
					gcloud run services add-iam-policy-binding "$SERVICE_NAME" --member="allUsers" --role="roles/run.invoker" --region="$REGION" --project="$PROJECT_ID" || true

