name: CD - Build & Deploy to Cloud Run

on:
  push:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
  CLOUD_SQL_CONNECTION_NAME: ${{ secrets.CLOUD_SQL_CONNECTION_NAME }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  VERSION: 1-0-0

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set fixed version
        id: get_version
        run: |
          echo "VERSION=1-0-0" >> $GITHUB_ENV
          echo "::set-output name=VERSION::1-0-0"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push API image
        run: |
          echo "Building API image..."
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/api:1-0-0 -t ${{ secrets.DOCKER_HUB_USERNAME }}/api:latest -f Dockerfile .
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/api:1-0-0
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/api:latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Run database migrations via Cloud SQL Proxy
        env:
          CLOUD_SQL_CONN: ${{ secrets.CLOUD_SQL_CONNECTION_NAME }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -e
          echo "Downloading Cloud SQL Proxy..."
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy

          echo "Starting Cloud SQL Proxy..."
          ./cloud_sql_proxy -instances=${CLOUD_SQL_CONN}=tcp:3306 &
          PROXY_PID=$!

          echo "Installing MySQL client..."
          sudo apt-get update -y
          sudo apt-get install -y default-mysql-client

          echo "Waiting for proxy to be ready..."
          sleep 8

          echo "Running SQL migrations (if any)..."
          if [ -f v1_CREATE_USER_DB.sql ]; then
            mysql -h 127.0.0.1 -P 3306 -u"${DB_USER}" -p"${DB_PASSWORD}" "${DB_NAME}" < v1_CREATE_USER_DB.sql || true
            echo "SQL migration executed (or no-op)."
          else
            echo "No SQL migration file found; skipping."
          fi

          echo "Stopping Cloud SQL Proxy"
          kill $PROXY_PID || true

      - name: Prepare Cloud Run service config
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          CLOUD_SQL_CONNECTION_NAME: ${{ secrets.CLOUD_SQL_CONNECTION_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          LOKI_URL: ${{ secrets.LOKI_URL }}
        run: |
          VERSION=${VERSION}
          echo "Generating cloud-run-service.yaml from template..."
          cp cloud-run-service.yaml.template cloud-run-service.yaml

          # Replace placeholders (match literal ${VAR} in template)
          sed -i "s|\${DOCKER_USERNAME}|${DOCKER_HUB_USERNAME}|g" cloud-run-service.yaml
          sed -i "s|\${VERSION}|${VERSION}|g" cloud-run-service.yaml

          DB_CONN="mysql+pymysql://${DB_USER}:${DB_PASSWORD}@/${DB_NAME}?unix_socket=/cloudsql/${CLOUD_SQL_CONNECTION_NAME}"
          sed -i "s|\${DB_CONNECTION_STRING}|${DB_CONN}|g" cloud-run-service.yaml

          if [ -n "${LOKI_URL}" ]; then
            sed -i "s|\${LOKI_URL}|${LOKI_URL}|g" cloud-run-service.yaml
          else
            sed -i "s|\${LOKI_URL}|""|g" cloud-run-service.yaml
          fi

          echo "cloud-run-service.yaml:"
          cat cloud-run-service.yaml

      - name: Deploy to Cloud Run
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: |
          VERSION=${VERSION}
          SERVICE_NAME="api-${VERSION}"
          echo "Replacing service on Cloud Run: $SERVICE_NAME"
          echo "GCP_REGION is '${GCP_REGION}'"

          gcloud run services replace cloud-run-service.yaml --region=${GCP_REGION} --platform=managed

          echo "Allowing unauthenticated invocations for $SERVICE_NAME"
          gcloud run services add-iam-policy-binding "$SERVICE_NAME" --region=${GCP_REGION} --member="allUsers" --role="roles/run.invoker" || true

          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" --region=${GCP_REGION} --format='value(status.url)')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Deployed: $SERVICE_URL"

      - name: Health check
        if: always()
        run: |
          SERVICE_URL=$(gcloud run services describe api-${{ steps.get_version.outputs.VERSION }} --region=${{ secrets.GCP_REGION }} --format='value(status.url)')
          echo "Health-checking $SERVICE_URL"
          sleep 8
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${SERVICE_URL}/health || true)
          echo "Health endpoint returned: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Health check passed"
          else
            echo "Health check failed or no /health endpoint (status: $HTTP_CODE)."
          fi
