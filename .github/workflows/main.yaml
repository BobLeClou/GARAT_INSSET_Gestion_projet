name: Main CI/CD Pipeline

on:
  push:
    tags:
      - 'v*.*.*'  # DÃ©clenche seulement sur les tags versions, ex v1.0.0

jobs:
  checkout_version:
    uses: ./.github/workflows/01_checkout_and_version.yml

  # build_api:
  #    needs: checkout_version
  #    uses: ./.github/workflows/02_build_api.yml
  #    with:
  #      version: ${{ needs.checkout_version.outputs.version }}
  #      docker_username: ${{ secrets.DOCKER_HUB_USERNAME }}
  #      docker_password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
  #
  #  build_fluentbit:
  #    needs: checkout_version
  #    uses: ./.github/workflows/03_build_fluentbit.yml
  #    with:
  #      version: ${{ needs.checkout_version.outputs.version }}
  #      docker_username: ${{ secrets.DOCKER_HUB_USERNAME }}
  #      docker_password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
  #
  #  gcloud_setup:
  #    needs: build_api
  #    uses: ./.github/workflows/04_gcloud_setup.yml
  #    with:
  #      gcp_sa_key: ${{ secrets.GCP_SA_KEY }}
  #      gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
  #      gcp_region: ${{ secrets.GCP_REGION }}
  #
  #  run_migrations:
  #    needs: gcloud_setup
  #    uses: ./.github/workflows/05_run_migrations.yml
  #    with:
  #      version: ${{ needs.checkout_version.outputs.version }}
  #      cloud_sql_connection_name: ${{ secrets.CLOUD_SQL_CONNECTION_NAME }}
  #      db_user: ${{ secrets.DB_USER }}
  #      db_password: ${{ secrets.DB_PASSWORD }}
  #
  #  update_cloud_run_config:
  #    needs: run_migrations
  #    uses: ./.github/workflows/06_update_cloud_run_config.yml
  #    with:
  #      version: ${{ needs.checkout_version.outputs.version }}
  #      docker_username: ${{ secrets.DOCKER_HUB_USERNAME }}
  #      gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
  #      gcp_region: ${{ secrets.GCP_REGION }}
  #      db_connection_string: ${{ secrets.DB_CONNECTION_STRING }}
  #      loki_url: ${{ secrets.LOKI_URL }}
  #
  #  deploy_cloud_run:
  #    needs: update_cloud_run_config
  #    uses: ./.github/workflows/07_deploy_cloud_run.yml
  #    with:
  #      gcp_project_id: ${{ secrets.GCP_PROJECT_ID }}
  #      gcp_region: ${{ secrets.GCP_REGION }}
