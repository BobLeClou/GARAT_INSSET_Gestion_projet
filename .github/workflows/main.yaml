name: CI/CD Google Cloud Run

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: "gcr.io/${{ secrets.GCP_PROJECT_ID }}/api"
  REPO_NAME: "artifact-repo"
  REGISTRY_LOCATION: "europe-west1"
  IMAGE_TAG: "1.0.0"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Configure Docker for GCR and Artifact Registry
      run: |
        # Configure docker auth for both gcr and Artifact Registry location
        gcloud auth configure-docker --quiet
        gcloud auth configure-docker --quiet ${REGISTRY_LOCATION}-docker.pkg.dev

    - name: Ensure Artifact Registry repository exists
      run: |
        REPO=${{ env.REPO_NAME }}
        LOCATION=${{ env.REGISTRY_LOCATION }}
        echo "Checking Artifact Registry repository '$REPO' in location '$LOCATION'"
        gcloud artifacts repositories describe "$REPO" --location="$LOCATION" || \
          gcloud artifacts repositories create "$REPO" --repository-format=docker --location="$LOCATION" --description="Docker repo for CI"

    - name: Set Artifact Registry image name and sanitize
      run: |
        IMAGE_NAME_ARTIFACT="${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/api"
        IMAGE_NAME_CLEAN=$(echo -n "$IMAGE_NAME_ARTIFACT" | tr -d '\r\n\t ')
        echo "IMAGE_NAME_CLEAN=$IMAGE_NAME_CLEAN" >> $GITHUB_ENV
        echo "Using image: $IMAGE_NAME_CLEAN:${IMAGE_TAG}"

    - name: Build Docker image
      run: |
        docker build -t "${IMAGE_NAME_CLEAN}:${IMAGE_TAG}" .

    - name: Push Docker image to Artifact Registry
      run: |
        docker push "${IMAGE_NAME_CLEAN}:${IMAGE_TAG}"

    - name: Setup variables and generate deployment file
      run: |
        VERSION=$IMAGE_TAG
        DB_CONN="mysql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@/$(echo ${{ secrets.DB_NAME }})?unix_socket=/cloudsql/${{ secrets.CLOUD_SQL_CONNECTION_NAME }}"
        sed -e "s|\${VERSION}|$VERSION|g" \
            -e "s|\${DOCKER_USERNAME}|$IMAGE_NAME_CLEAN|g" \
            -e "s|\${DB_CONNECTION_STRING}|$DB_CONN|g" \
            -e "s|\${LOKI_URL}|${{ secrets.LOKI_URL }}|g" \
            cloud-run-service.yaml.template > cloud-run-service.yaml

    - name: Deploy to Cloud Run
      run: |
        gcloud run services replace cloud-run-service.yaml --region=${{ secrets.GCP_REGION }}

