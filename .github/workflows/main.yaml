
on:
  push:

env:
  IMAGE_API_NAME: "api"
  IMAGE_FLUENTBIT_NAME: "fluentbit"
  VERSION: "1.0.0"

jobs:
  build_and_push_api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Write GCP service account key to file (for this job)
        run: |
          printf '%s' "${{ secrets.GCP_SA_KEY }}" > ./gcloud-service-key.json
          chmod 600 ./gcloud-service-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcloud-service-key.json" >> $GITHUB_ENV

      - name: Write GCP service account key to file
        run: |
          printf '%s' "${{ secrets.GCP_SA_KEY }}" > ./gcloud-service-key.json
          chmod 600 ./gcloud-service-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcloud-service-key.json" >> $GITHUB_ENV

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login --username ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin

      - name: Build API image
        run: |
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_API_NAME }}:${{ env.VERSION }} .
          docker tag ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_API_NAME }}:${{ env.VERSION }} ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_API_NAME }}:latest

      - name: Push API images
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_API_NAME }}:${{ env.VERSION }}
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_API_NAME }}:latest

  build_and_push_fluentbit:
    needs: build_and_push_api
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login --username ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin

      - name: Pull official Fluent Bit image
        run: |
          docker pull fluent/fluent-bit:2.1

      - name: Retag and push Fluent Bit to Docker Hub
        run: |
          docker tag fluent/fluent-bit:2.1 ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_FLUENTBIT_NAME }}:${{ env.VERSION }}
          docker tag fluent/fluent-bit:2.1 ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_FLUENTBIT_NAME }}:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_FLUENTBIT_NAME }}:${{ env.VERSION }}
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_FLUENTBIT_NAME }}:latest

  gcloud_setup:
    needs: build_and_push_fluentbit
    runs-on: ubuntu-latest
    steps:
      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure gcloud region
        run: gcloud config set run/region ${{ secrets.GCP_REGION }}

  run_migrations:
    needs: gcloud_setup
    runs-on: ubuntu-latest
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      CLOUD_SQL_CONNECTION_NAME: ${{ secrets.CLOUD_SQL_CONNECTION_NAME }}
      DB_NAME: ${{ secrets.DB_NAME }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Download Cloud SQL Proxy
        run: |
          curl -fSsLO "https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.19.0/cloud-sql-proxy.linux.amd64"
          chmod +x cloud-sql-proxy.linux.amd64

      - name: Install MySQL client
        run: sudo apt-get update && sudo apt-get install -y default-mysql-client

      - name: Start Cloud SQL Proxy and run SQL script
        run: |
          mkdir -p /tmp/cloudsql
          ./cloud-sql-proxy.linux.amd64 --unix-socket=/tmp/cloudsql ${CLOUD_SQL_CONNECTION_NAME} &
          sleep 15
          echo "Using DB_NAME=${DB_NAME}"
          mysql -S /tmp/cloudsql/${CLOUD_SQL_CONNECTION_NAME} -u"${DB_USER}" -p"${DB_PASSWORD}" "${DB_NAME}" < v1_CREATE_USER_DB.sql

  update_cloud_run_config:
    needs: run_migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Replace placeholders in cloud-run-service.yaml
        run: |
          sed -i "s/{{VERSION}}/${{ env.VERSION }}/g" cloud-run-service.yaml
          sed -i "s/{{DOCKER_USERNAME}}/${{ secrets.DOCKER_HUB_USERNAME }}/g" cloud-run-service.yaml
          sed -i "s/{{GCP_PROJECT_ID}}/${{ secrets.GCP_PROJECT_ID }}/g" cloud-run-service.yaml
          sed -i "s/{{GCP_REGION}}/${{ secrets.GCP_REGION }}/g" cloud-run-service.yaml
          sed -i "s#{{DB_CONNECTION_STRING}}#${{ secrets.DB_CONNECTION_STRING }}#g" cloud-run-service.yaml
          sed -i "s#{{LOKI_URL}}#${{ secrets.LOKI_URL }}#g" cloud-run-service.yaml

  deploy_cloud_run:
    needs: update_cloud_run_config
    runs-on: ubuntu-latest
    steps:
      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Deploy Cloud Run service
        run: |
          gcloud run services replace cloud-run-service.yaml
          SERVICE_NAME=$(yq e '.metadata.name' cloud-run-service.yaml)
          gcloud run services add-iam-policy-binding "$SERVICE_NAME" --member="allUsers" --role="roles/run.invoker" || echo "Policy binding may already exist"
