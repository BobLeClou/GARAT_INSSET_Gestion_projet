name: Run Migrations

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      cloud_sql_connection_name:
        required: true
        type: string
      db_user:
        required: true
        type: string
      db_password:
        required: true
        type: string

jobs:
  migrations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Migration Image
        run: |
          docker build -f Dockerfile.migrations -t migration-image:${{ inputs.version }} .

      - name: Run Migrations via Cloud SQL Proxy
        run: |
          # Commande pour exécuter les migrations avec cloud-sql-proxy
          # Exemple fictif, à adapter à ta méthode réelle de migration
          ./cloud_sql_proxy -instances=${{ inputs.cloud_sql_connection_name }}=tcp:5432 &
          docker run --rm -e DB_USER=${{ inputs.db_user }} -e DB_PASSWORD=${{ inputs.db_password }} migration-image:${{ inputs.version }} migrate
